<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üêô gitja - Make config options nicer</title>
    <link rel="stylesheet" type="text/css" href="https://gitja.mcol.xyz/style.css"/>
    <link rel="icon" type="image/png" href="https://gitja.mcol.xyz/favicon.png"/>
  </head>

  <body>
    <a id="heada" href="https://gitja.mcol.xyz">
      <header>
        <h1 id="title">gitja</h1>
        <h2 id="desc">üêô Templated web page generator for your git repositories</h2>
      </header>
    </a>

    <div id="nav">
      <span id="url">git clone <a href="https://github.com/m-col/gitja">https://github.com/m-col/gitja</a></span>

      <span id="links">
        <a href="https://gitja.mcol.xyz">Home</a> |
        <a href="https://gitja.mcol.xyz/gitja/log.html">Log</a> |
        <a href="https://gitja.mcol.xyz/gitja/tree.html">Files</a> |
        <a href="https://gitja.mcol.xyz/gitja/refs.html">Refs</a> |
        <a href="https://gitja.mcol.xyz/gitja/file/README.rst.html">Readme</a> |
        <a href="https://gitja.mcol.xyz/gitja/file/LICENSE.html">License</a>
      </span>

      <p id="tag">
        Docs built @ <a href="https://gitja.mcol.xyz/gitja/commit/82d8bb4a843c40aad1997e49a8917f3de93676ef.html">82d8bb4</a>
      </p>
    </div>

    <div id="content">
      <pre><b>Commit</b> <a href="https://gitja.mcol.xyz/gitja/commit/174d8aaaea29ef5cc1aecd98ab2cefe1d72aad5a.html">174d8aaaea29ef5cc1aecd98ab2cefe1d72aad5a</a>
<b>Parent:</b> <a href="https://gitja.mcol.xyz/gitja/commit/d8a16891b85e1bcf43e78c426aab5f937a4311a8.html">d8a16891b85e1bcf43e78c426aab5f937a4311a8</a>
<b>Author:</b> mcol &lt;<a href="mailto:mcol@posteo.net">mcol@posteo.net</a>&gt;
<b>Date:</b> 2021-12-04 00:24:29 +0300
<b>Committer:</b> mcol &lt;<a href="mailto:mcol@posteo.net">mcol@posteo.net</a>&gt;
<b>Committed:</b> 2021-12-04 00:24:29 +0300

Make config options nicer
</pre><div class="diff">
  <p>
    <b>test/config.dhall</b>
    <span class="status">Modified</span>
  </p>

  @@ -1,8 +1,8 @@


  <pre><span class="def"> let config =
</span><span class="sub">-    { repoPaths = [&quot;.&quot;]
</span><span class="sub">-    , scanRepoPaths = False
</span><span class="sub">-    , templateDirectory = &quot;./test/templates&quot;
</span><span class="sub">-    , outputDirectory = &quot;./test/result&quot;
</span><span class="add">+    { repos = [&quot;.&quot;]
</span><span class="add">+    , scan = False
</span><span class="add">+    , template = &quot;./test/templates&quot;
</span><span class="add">+    , output = &quot;./test/result&quot;
</span><span class="def">     , host = &quot;https://github.com/m-col/gitserve&quot;
</span><span class="def">     }
</span><span class="def"> 
</span></pre></div><div class="diff">
  <p>
    <b>templates/README.rst</b>
    <span class="status">Modified</span>
  </p>

  @@ -4,7 +4,7 @@


  <pre><span class="def"> This folder contains some example templates for demonstration purposes.
</span><span class="def"> 
</span><span class="def"> They can be used for generation by specifying the path of one of the folders in
</span><span class="sub">-the ``gitserve`` configuration file as the ``templateDirectory``.
</span><span class="add">+the configuration file as the ``template``.
</span><span class="def"> 
</span><span class="def"> If you make a nice template and would like to share it, contributions of more
</span><span class="def"> folders here would be very welcome!
</span></pre></div><div class="diff">
  <p>
    <b>src/config.dhall</b>
    <span class="status">Modified</span>
  </p>

  @@ -12,13 +12,17 @@


  <pre><span class="def"> -- These are the configurable options that are used by gitserve.
</span><span class="def"> -- You may want to replace the relative paths for absolute paths.
</span><span class="def"> let config =
</span><span class="sub">-    { repoPaths = folders
</span><span class="sub">-    , scanRepoPaths = True
</span><span class="sub">-    , templateDirectory = &quot;./template&quot;
</span><span class="sub">-    , outputDirectory = &quot;./output&quot;
</span><span class="add">+    { repos = folders
</span><span class="add">+    , scan = False
</span><span class="add">+    , template = &quot;./template&quot;
</span><span class="add">+    , output = &quot;./output&quot;
</span><span class="def">     , host = &quot;http://localhost:8000&quot;
</span><span class="def">     }
</span><span class="def"> 
</span><span class="add">+-- If `scan` is True, then gitserve will look for git repositories in folders
</span><span class="add">+-- nested within those listed in `repos`. Otherwise, the folders in `repos` are
</span><span class="add">+-- assumed to be repositories themselves.
</span><span class="add">+
</span><span class="def"> -- Note: The host is available verbatim in templates.
</span><span class="def"> -- Port 8000 is appended here for easier testing with `python -m http.server`.
</span><span class="def"> 
</span></pre></div><div class="diff">
  <p>
    <b>src/Templates.hs</b>
    <span class="status">Modified</span>
  </p>

  @@ -59,8 +59,8 @@


  <pre><span class="def">     , envCommitTemplate :: Maybe Template
</span><span class="def">     , envFileTemplate :: Maybe Template
</span><span class="def">     , envRepoTemplates :: [Template]
</span><span class="sub">-    , envOutputDirectory :: Path Abs Dir
</span><span class="sub">-    , envRepoPaths :: [Path Abs Dir]
</span><span class="add">+    , envOutput :: Path Abs Dir
</span><span class="add">+    , envRepos :: [Path Abs Dir]
</span><span class="def">     , envHost :: T.Text
</span><span class="def">     , envQuiet :: Bool
</span><span class="def">     , envForce :: Bool
</span></pre>@@ -78,20 +78,20 @@


  <pre><span class="def"> loadEnv :: Bool -&gt; Bool -&gt; Config -&gt; IO Env
</span><span class="def"> loadEnv quiet force config = do
</span><span class="def">     -- First ensure that the output directory exists
</span><span class="sub">-    output &lt;- parseAbsDir &lt;=&lt; canonicalizePath . confOutputDirectory $ config
</span><span class="add">+    output &lt;- parseAbsDir &lt;=&lt; canonicalizePath . confOutput $ config
</span><span class="def">     ensureDir output
</span><span class="def"> 
</span><span class="def">     -- Parse repos for env
</span><span class="sub">-    repoPaths &lt;-
</span><span class="sub">-        if confScanRepoPaths config
</span><span class="add">+    repos &lt;-
</span><span class="add">+        if confScan config
</span><span class="def">             then do
</span><span class="sub">-                ps &lt;- fmap concat . mapM (fmap fst . ls) . confRepoPaths $ config
</span><span class="add">+                ps &lt;- fmap concat . mapM (fmap fst . ls) . confRepos $ config
</span><span class="def">                 return . filter ((/=) &quot;.git&quot; . toFilePath . dirname) $ ps
</span><span class="sub">-            else mapM (parseAbsDir &lt;=&lt; canonicalizePath) . confRepoPaths $ config
</span><span class="add">+            else mapM (parseAbsDir &lt;=&lt; canonicalizePath) . confRepos $ config
</span><span class="def"> 
</span><span class="def">     -- Find template files, copying the static files as is
</span><span class="sub">-    (dirs, files) &lt;- ls . confTemplateDirectory $ config
</span><span class="sub">-    (_, filesRepo) &lt;- ls $ confTemplateDirectory config FP.&lt;/&gt; &quot;repo&quot;
</span><span class="add">+    (dirs, files) &lt;- ls . confTemplate $ config
</span><span class="add">+    (_, filesRepo) &lt;- ls $ confTemplate config FP.&lt;/&gt; &quot;repo&quot;
</span><span class="def">     copyStaticDirs output dirs
</span><span class="def">     copyStaticFiles output files
</span><span class="def"> 
</span></pre>@@ -112,8 +112,8 @@


  <pre><span class="def">             , envCommitTemplate = commitT
</span><span class="def">             , envFileTemplate = fileT
</span><span class="def">             , envRepoTemplates = repoT
</span><span class="sub">-            , envOutputDirectory = output
</span><span class="sub">-            , envRepoPaths = repoPaths
</span><span class="add">+            , envOutput = output
</span><span class="add">+            , envRepos = repos
</span><span class="def">             , envHost = confHost config
</span><span class="def">             , envQuiet = quiet
</span><span class="def">             , envForce = force
</span></pre>@@ -187,15 +187,15 @@


  <pre><span class="def"> 
</span><span class="def"> {-
</span><span class="def"> The logic for copying static files and folders. Any file or folder in the
</span><span class="sub">-``confTemplateDirectory`` is considered static if:
</span><span class="add">+``confTemplate`` is considered static if:
</span><span class="def"> 
</span><span class="def"> - it is a symbolic link, or
</span><span class="def"> - it does not end in &quot;.html&quot; or &quot;.include&quot;.
</span><span class="def"> 
</span><span class="def"> Symbolic links are not followed and are copied as is. This means that a symbolic link
</span><span class="sub">-from `confTemplateDirectory/link.html` to `gitserve/index.html` will be copied, keeping the
</span><span class="sub">-link intact, resulting in a symbolic link at `outputDirectory/link.html` essentially
</span><span class="sub">-pointing to `outputDirectory/gitserve/index.html`.
</span><span class="add">+from `confTemplate/link.html` to `gitserve/index.html` will be copied, keeping the
</span><span class="add">+link intact, resulting in a symbolic link at `output/link.html` essentially
</span><span class="add">+pointing to `output/gitserve/index.html`.
</span><span class="def"> -}
</span><span class="def"> -- TODO: merge isStatic and copy so it&apos;s just one step
</span><span class="def"> copyStaticDirs :: Path Abs Dir -&gt; [Path Abs Dir] -&gt; IO ()
</span></pre></div><div class="diff">
  <p>
    <b>src/Repositories.hs</b>
    <span class="status">Modified</span>
  </p>

  @@ -46,7 +46,7 @@


  <pre><span class="def"> -}
</span><span class="def"> loadRepos :: Env -&gt; IO [Repo]
</span><span class="def"> loadRepos env = do
</span><span class="sub">-    paths&apos; &lt;- filterM (fmap isRight . okRepo) . envRepoPaths $ env
</span><span class="add">+    paths&apos; &lt;- filterM (fmap isRight . okRepo) . envRepos $ env
</span><span class="def">     descs &lt;- mapM getDescription paths&apos;
</span><span class="def">     return . fmap ($ Nothing) . zipWith Repo paths&apos; $ descs
</span><span class="def">   where
</span></pre>@@ -71,7 +71,7 @@


  <pre><span class="def"> processRepo&apos; :: Env -&gt; [Repo] -&gt; Repo -&gt; ReaderT LgRepo IO Repo
</span><span class="def"> processRepo&apos; env repos repo = do
</span><span class="def">     let name = dirname . repositoryPath $ repo
</span><span class="sub">-    let output = envOutputDirectory env &lt;/&gt; name
</span><span class="add">+    let output = envOutput env &lt;/&gt; name
</span><span class="def"> 
</span><span class="def">     resolveReference &quot;HEAD&quot; &gt;&gt;= \case
</span><span class="def">         Nothing -&gt; do
</span></pre></div><div class="diff">
  <p>
    <b>src/Main.hs</b>
    <span class="status">Modified</span>
  </p>

  @@ -103,12 +103,12 @@


  <pre><span class="def">                 B.writeFile &quot;./config.dhall&quot; config
</span><span class="def">                 putStrLn &quot;A base template as been put at ./template.&quot;
</span><span class="def">                 putStrLn &quot;A plain config has been put at ./config.dhall&quot;
</span><span class="sub">-                putStrLn &quot;Add a local git repository to repoPaths in the config&quot;
</span><span class="add">+                putStrLn &quot;Add a local git repository to &apos;repos&apos; in the config&quot;
</span><span class="def">                 putStrLn &quot;and run gitserve to generate HTML in ./output.&quot;
</span><span class="def">                 oExists &lt;- D.doesPathExist &quot;./output&quot;
</span><span class="def">                 when oExists . putStrLn $
</span><span class="def">                     &quot;WARNING: ./output ALREADY EXISTS AND WILL BE OVERWRITTEN\n&quot;
</span><span class="sub">-                        &lt;&gt; &quot;UNLESS YOU MOVE/RENAME IT OR CHANGE GITSERVE&apos;S outputDirectory.&quot;
</span><span class="add">+                        &lt;&gt; &quot;UNLESS YOU MOVE/RENAME IT OR CHANGE GITSERVE&apos;S output.&quot;
</span><span class="def">   where
</span><span class="def">     base :: [(FilePath, B.ByteString)]
</span><span class="def">     base = $(embedDir &quot;templates/base&quot;)
</span></pre></div><div class="diff">
  <p>
    <b>src/Index.hs</b>
    <span class="status">Modified</span>
  </p>

  @@ -26,7 +26,7 @@


  <pre><span class="def"> 
</span><span class="def"> runIndexFile :: Env -&gt; [Repo] -&gt; Template -&gt; IO ()
</span><span class="def"> runIndexFile env repos template = do
</span><span class="sub">-    let output = combine (toFilePath . envOutputDirectory $ env) . toFilePath . templatePath $ template
</span><span class="add">+    let output = combine (toFilePath . envOutput $ env) . toFilePath . templatePath $ template
</span><span class="def">     unless (envQuiet env) . putStrLn $ &quot;Writing &quot; &lt;&gt; output
</span><span class="def">     writeFile output &quot;&quot; -- Clear contents of file if it exists
</span><span class="def">     void $
</span></pre></div><div class="diff">
  <p>
    <b>src/Config.hs</b>
    <span class="status">Modified</span>
  </p>

  @@ -16,10 +16,10 @@


  <pre><span class="def"> import System.Directory (makeAbsolute)
</span><span class="def"> 
</span><span class="def"> data Config = Config
</span><span class="sub">-    { confRepoPaths :: [FilePath]
</span><span class="sub">-    , confScanRepoPaths :: Bool
</span><span class="sub">-    , confTemplateDirectory :: FilePath
</span><span class="sub">-    , confOutputDirectory :: FilePath
</span><span class="add">+    { confRepos :: [FilePath]
</span><span class="add">+    , confScan :: Bool
</span><span class="add">+    , confTemplate :: FilePath
</span><span class="add">+    , confOutput :: FilePath
</span><span class="def">     , confHost :: Text
</span><span class="def">     }
</span><span class="def">     deriving stock (Generic)
</span></pre></div><div class="diff">
  <p>
    <b>config.dhall</b>
    <span class="status">Modified</span>
  </p>

  @@ -12,13 +12,17 @@


  <pre><span class="def"> -- These are the configurable options that are used by gitserve.
</span><span class="def"> -- If copying, you may want to replace the relative paths for absolute paths.
</span><span class="def"> let config =
</span><span class="sub">-    { repoPaths = folders
</span><span class="sub">-    , scanRepoPaths = False
</span><span class="sub">-    , templateDirectory = &quot;./templates/docs&quot;
</span><span class="sub">-    , outputDirectory = &quot;./output&quot;
</span><span class="add">+    { repos = folders
</span><span class="add">+    , scan = False
</span><span class="add">+    , template = &quot;./templates/docs&quot;
</span><span class="add">+    , output = &quot;./output&quot;
</span><span class="def">     , host = &quot;http://localhost:8000&quot;
</span><span class="def">     }
</span><span class="def"> 
</span><span class="add">+-- If `scan` is True, then gitserve will look for git repositories in folders
</span><span class="add">+-- nested within those listed in `repos`. Otherwise, the folders in `repos` are
</span><span class="add">+-- assumed to be repositories themselves.
</span><span class="add">+
</span><span class="def"> -- Note: The host is available verbatim in templates.
</span><span class="def"> -- Port 8000 is appended here for easier testing with `python -m http.server`.
</span><span class="def"> 
</span></pre></div><div class="diff">
  <p>
    <b>DOCUMENTATION.md</b>
    <span class="status">Modified</span>
  </p>

  @@ -16,13 +16,17 @@


  <pre><span class="def"> 
</span><span class="def"> It requires the following settings:
</span><span class="def"> 
</span><span class="sub">-| Setting             | Description                                         |
</span><span class="sub">-| ------------------- | --------------------------------------------------- |
</span><span class="sub">-| `repoPaths`         | A list of folders containing your git repositories. |
</span><span class="sub">-| `scanRepoPaths`     | Whether `repoPaths` lists repos or folders containing nested repos. |
</span><span class="sub">-| `templateDirectory` | The folder containing the template (see below).     |
</span><span class="sub">-| `outputDirectory`   | Where to put the generated files.                   |
</span><span class="sub">-| `host`              | The host URL, which is needed for creating links.   |
</span><span class="add">+| Setting    | Description                                                     |
</span><span class="add">+| ---------- | --------------------------------------------------------------- |
</span><span class="add">+| `repos`    | A list of folders containing your git repositories.             |
</span><span class="add">+| `scan`     | Whether `repos` lists repos or folders containing nested repos. |
</span><span class="add">+| `template` | The folder containing the template (see below).                 |
</span><span class="add">+| `output`   | Where to put the generated files.                               |
</span><span class="add">+| `host`     | The host URL, which is needed for creating links.               |
</span><span class="add">+
</span><span class="add">+If `scan` is `True`, then gitserve will look for git repositories in folders
</span><span class="add">+nested within those listed in `repos`. Otherwise, the folders in `repos` are
</span><span class="add">+assumed to be repositories themselves.
</span><span class="def"> 
</span><span class="def"> Then, pass the config file to gitserve.
</span><span class="def"> 
</span></pre>@@ -42,7 +46,7 @@


  <pre><span class="def">       -v,--version             Print the gitserve&apos;s version.
</span><span class="def">       -h,--help                Show this help text
</span><span class="def"> 
</span><span class="sub">-Note the &quot;force&quot; flag. By default, gitserve will not generate new output for
</span><span class="add">+Note the `force` flag. By default, gitserve will not generate new output for
</span><span class="def"> commits to save time. This flag will force regeneration of all files, which
</span><span class="def"> would be needed if changes have been made to the template.
</span><span class="def"> 
</span></pre>@@ -69,7 +73,7 @@


  <pre><span class="def"> 
</span><span class="def"> To illustrate, this is the expected structure:
</span><span class="def"> 
</span><span class="sub">-    templateDirectory/
</span><span class="add">+    template/
</span><span class="def">         i_can_have_any_name.html
</span><span class="def">         and_there_can_be_any_number.html
</span><span class="def">         some_might_be_ginger_includes.html.include
</span></pre>@@ -80,8 +84,8 @@


  <pre><span class="def">             file.html
</span><span class="def">             commit.html
</span><span class="def"> 
</span><span class="sub">-The top-level folder, here `templateDirectory`, is that which is specified in
</span><span class="sub">-the config file.
</span><span class="add">+The top-level folder, here `template`, is that which is specified in the config
</span><span class="add">+file.
</span><span class="def"> 
</span><span class="def"> Files ending in &quot;.html&quot; directly within that folder have access to the *index
</span><span class="def"> scope*, and are each parsed exactly once and output into the output directory
</span></pre>@@ -99,10 +103,10 @@


  <pre><span class="def"> &quot;file.html&quot; and &quot;commit.html&quot;. These have access to the *file scope* and
</span><span class="def"> *commit scope* respectively, and are parsed and output once per file or commit.
</span><span class="def"> 
</span><span class="sub">-The resulting folder structure found in the `outputDirectory` will look like
</span><span class="sub">-this (if the only specified git repository is gitserve):
</span><span class="add">+The resulting folder structure found in `output` will look like this (if
</span><span class="add">+`repos` only contains gitserve):
</span><span class="def"> 
</span><span class="sub">-    outputDirectory/
</span><span class="add">+    output/
</span><span class="def">         i_can_have_any_name.html
</span><span class="def">         and_there_can_be_any_number.html
</span><span class="def">         non_html_is_fine.css
</span></pre>@@ -121,10 +125,10 @@


  <pre><span class="def"> 
</span><span class="def"> Note: symbolic links are considered static and will be copied unchanged and
</span><span class="def"> unresolved from template to output. This means that, for example, a symlink at
</span><span class="sub">-`templateDirectory/index.html` pointing to `gitserve/index.html` will produce a
</span><span class="sub">-symlink at `outputDirectory/index.html` with the same behaviour, with the
</span><span class="sub">-effect that the served root index page will actually be the index page for the
</span><span class="sub">-`gitserve` repository (if present).
</span><span class="add">+`template/index.html` pointing to `gitserve/index.html` will produce a symlink
</span><span class="add">+at `output/index.html` with the same behaviour, with the effect that the served
</span><span class="add">+root index page will actually be the index page for the `gitserve` repository
</span><span class="add">+(if present).
</span><span class="def"> 
</span><span class="def"> ### Scopes
</span><span class="def"> 
</span></pre></div>    </div>
  </body>
</html>
