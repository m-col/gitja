<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üêô gitja - Fully qualify contents of folders and expose all tree entry prpoerties</title>
    <link rel="stylesheet" type="text/css" href="https://gitja.mcol.xyz/style.css"/>
    <link rel="icon" type="image/png" href="https://gitja.mcol.xyz/favicon.png"/>
  </head>

  <body>
    <a id="heada" href="https://gitja.mcol.xyz">
      <header>
        <h1 id="title">gitja</h1>
        <h2 id="desc">üêô Templated web page generator for your git repositories</h2>
      </header>
    </a>

    <div id="nav">
      <span id="url">git clone <a href="https://github.com/m-col/gitja">https://github.com/m-col/gitja</a></span>

      <span id="links">
        <a href="https://gitja.mcol.xyz">Home</a> |
        <a href="https://gitja.mcol.xyz/gitja/log.html">Log</a> |
        <a href="https://gitja.mcol.xyz/gitja/tree.html">Files</a> |
        <a href="https://gitja.mcol.xyz/gitja/refs.html">Refs</a> |
        <a href="https://gitja.mcol.xyz/gitja/file/README.rst.html">Readme</a> |
        <a href="https://gitja.mcol.xyz/gitja/file/LICENSE.html">License</a>
      </span>

      <p id="tag">
        Docs built @ <a href="https://gitja.mcol.xyz/gitja/commit/3140f07b47a7e7b2fa277f3a05df876f2162f510.html">3140f07</a>
      </p>
    </div>

    <div id="content">
      <pre><b>Commit</b> <a href="https://gitja.mcol.xyz/gitja/commit/6aab808c286bf022b308d712eea740f2f7c34445.html">6aab808c286bf022b308d712eea740f2f7c34445</a>
<b>Parent:</b> <a href="https://gitja.mcol.xyz/gitja/commit/0963258ffce3ee3f5dee287468e605f2970818aa.html">0963258ffce3ee3f5dee287468e605f2970818aa</a>
<b>Author:</b> mcol &lt;<a href="mailto:mcol@posteo.net">mcol@posteo.net</a>&gt;
<b>Date:</b> 2021-11-22 20:15:50 +0000
<b>Committer:</b> mcol &lt;<a href="mailto:mcol@posteo.net">mcol@posteo.net</a>&gt;
<b>Committed:</b> 2021-11-22 20:15:50 +0000

Fully qualify contents of folders and expose all tree entry prpoerties

This lets the contents of a folder (i.e. `file.contents` where `file` is
a tree entry listing that is a directory) be represented as a list of
more tree entries. Recursive properties should work as expected.

Closes #5
</pre><div class="diff">
  <p>
    <b>src/Types.hs</b>
    <span class="status">Modified</span>
  </p>

  @@ -60,7 +60,7 @@


  <pre><span class="def">     , treeFileMode :: TreeEntryMode
</span><span class="def">     }
</span><span class="def"> 
</span><span class="sub">-data TreeFileContents = FileContents Text | FolderContents [TreeFilePath]
</span><span class="add">+data TreeFileContents = FileContents Text | FolderContents [TreeFile]
</span><span class="def"> 
</span><span class="def"> data TreeEntryMode = ModeDirectory | ModePlain | ModeExecutable | ModeSymlink | ModeSubmodule
</span><span class="def">     deriving stock (Show)
</span></pre>@@ -109,11 +109,11 @@


  <pre><span class="def"> instance ToGVal m TreeFileContents where
</span><span class="def">     toGVal :: TreeFileContents -&gt; GVal m
</span><span class="def">     toGVal (FileContents text) = toGVal text
</span><span class="sub">-    toGVal (FolderContents filePaths) =
</span><span class="add">+    toGVal (FolderContents treeFiles) =
</span><span class="def">         def
</span><span class="sub">-            { asHtml = html . pack . show $ filePaths
</span><span class="sub">-            , asText = pack . show $ filePaths
</span><span class="sub">-            , asList = Just . fmap toGVal $ filePaths
</span><span class="add">+            { asHtml = html . pack . show . fmap (toString . treeFilePath) $ treeFiles
</span><span class="add">+            , asText = pack . show . fmap (toString . treeFilePath) $ treeFiles
</span><span class="add">+            , asList = Just . fmap toGVal $ treeFiles
</span><span class="def">             }
</span><span class="def"> 
</span><span class="def"> treeAsLookup :: TreeFile -&gt; Text -&gt; Maybe (GVal m)
</span></pre></div><div class="diff">
  <p>
    <b>src/Repositories.hs</b>
    <span class="status">Modified</span>
  </p>

  @@ -119,19 +119,28 @@


  <pre><span class="def"> loadCommit _ = Nothing
</span><span class="def"> 
</span><span class="def"> {-
</span><span class="sub">-Collect tree information.
</span><span class="add">+Collect tree information for the given commit. Recurses on directories to list their
</span><span class="add">+contents.
</span><span class="def"> -}
</span><span class="def"> getTree :: CommitOid LgRepo -&gt; ReaderT LgRepo IO [TreeFile]
</span><span class="sub">-getTree commitID = do
</span><span class="sub">-    entries &lt;- listTreeEntries =&lt;&lt; lookupTree . commitTree =&lt;&lt; lookupCommit commitID
</span><span class="sub">-    contents &lt;- mapM (getEntryContents . snd) entries
</span><span class="sub">-    modes &lt;- mapM (getEntryModes . snd) entries
</span><span class="sub">-    return $ zipWith3 TreeFile (fmap fst entries) contents modes
</span><span class="sub">-
</span><span class="sub">-getEntryContents :: TreeEntry LgRepo -&gt; ReaderT LgRepo IO TreeFileContents
</span><span class="sub">-getEntryContents (BlobEntry oid _) = FileContents . decodeUtf8With lenientDecode &lt;$&gt; catBlob oid
</span><span class="sub">-getEntryContents (TreeEntry oid) = FolderContents . fmap fst &lt;$&gt; (listTreeEntries =&lt;&lt; lookupTree oid)
</span><span class="sub">-getEntryContents (CommitEntry oid) = return . FileContents . pack . show . untag $ oid
</span><span class="add">+getTree = getTree&apos; &quot;&quot; . commitTree &lt;=&lt; lookupCommit
</span><span class="add">+
</span><span class="add">+getTree&apos; :: TreeFilePath -&gt; TreeOid LgRepo -&gt; ReaderT LgRepo IO [TreeFile]
</span><span class="add">+getTree&apos; parent toid = do
</span><span class="add">+    entries &lt;- listTreeEntries =&lt;&lt; lookupTree toid
</span><span class="add">+    let entries&apos; = fmap (prependParent parent) entries
</span><span class="add">+    contents &lt;- mapM getEntryContents entries&apos;
</span><span class="add">+    modes &lt;- mapM (getEntryModes . snd) entries&apos;
</span><span class="add">+    return $ zipWith3 TreeFile (fmap fst entries&apos;) contents modes
</span><span class="add">+
</span><span class="add">+prependParent :: TreeFilePath -&gt; (TreeFilePath, TreeEntry LgRepo) -&gt; (TreeFilePath, TreeEntry LgRepo)
</span><span class="add">+prependParent &quot;&quot; pathentry = pathentry
</span><span class="add">+prependParent parent (path, entry) = (mconcat [parent, &quot;/&quot;, path], entry)
</span><span class="add">+
</span><span class="add">+getEntryContents :: (TreeFilePath, TreeEntry LgRepo) -&gt; ReaderT LgRepo IO TreeFileContents
</span><span class="add">+getEntryContents (_, BlobEntry oid _) = FileContents . decodeUtf8With lenientDecode &lt;$&gt; catBlob oid
</span><span class="add">+getEntryContents (path, TreeEntry oid) = FolderContents &lt;$&gt; getTree&apos; path oid
</span><span class="add">+getEntryContents (_, CommitEntry oid) = return . FileContents . pack . show . untag $ oid
</span><span class="def"> 
</span><span class="def"> getEntryModes :: TreeEntry LgRepo -&gt; ReaderT LgRepo IO TreeEntryMode
</span><span class="def"> getEntryModes (BlobEntry _ kind) = return . blobkindToMode $ kind
</span></pre></div>    </div>
  </body>
</html>
