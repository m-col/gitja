<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üêô gitja - Check commit diffs to update outputs for only updated files</title>
    <link rel="stylesheet" type="text/css" href="https://gitserve.mcol.xyz/style.css"/>
    <link rel="icon" type="image/png" href="https://gitserve.mcol.xyz/favicon.png"/>
  </head>

  <body>
    <a id="heada" href="https://gitserve.mcol.xyz">
      <header>
        <h1 id="title">gitja</h1>
        <h2 id="desc">üêô Templated web page generator for your git repositories</h2>
      </header>
    </a>

    <div id="nav">
      <span id="url">git clone <a href="https://github.com/m-col/gitja">https://github.com/m-col/gitja</a></span>

      <span id="links">
        <a href="https://gitserve.mcol.xyz">Home</a> |
        <a href="https://gitserve.mcol.xyz/gitja/log.html">Log</a> |
        <a href="https://gitserve.mcol.xyz/gitja/tree.html">Files</a> |
        <a href="https://gitserve.mcol.xyz/gitja/refs.html">Refs</a> |
        <a href="https://gitserve.mcol.xyz/gitja/file/README.rst.html">Readme</a> |
        <a href="https://gitserve.mcol.xyz/gitja/file/LICENSE.html">License</a>
      </span>

      <p id="tag">
        Docs built @ <a href="https://gitserve.mcol.xyz/gitja/commit/dd887ab4dff2f47110b7f584e357e86826b76369.html">dd887ab</a>
      </p>
    </div>

    <div id="content">
      <pre><b>Commit</b> <a href="https://gitserve.mcol.xyz/gitja/commit/2b5e93377bab6ebf38f5e06cebdd49418093d9de.html">2b5e93377bab6ebf38f5e06cebdd49418093d9de</a>
<b>Parent:</b> <a href="https://gitserve.mcol.xyz/gitja/commit/8ba4cbfe7f06ed441920a74315705f7a24a09984.html">8ba4cbfe7f06ed441920a74315705f7a24a09984</a>
<b>Author:</b> mcol &lt;<a href="mailto:mcol@posteo.net">mcol@posteo.net</a>&gt;
<b>Date:</b> 2022-06-04 23:01:53 +0100
<b>Committer:</b> mcol &lt;<a href="mailto:mcol@posteo.net">mcol@posteo.net</a>&gt;
<b>Committed:</b> 2022-06-04 23:08:43 +0100

Check commit diffs to update outputs for only updated files
</pre><div class="diff">
  <p>
    <b>src/Types.hs</b>
    <span class="status">Modified</span>
  </p>

  @@ -91,8 +91,8 @@


  <pre><span class="def"> 
</span><span class="def"> commitAsLookup :: Commit -&gt; T.Text -&gt; Maybe (GVal m)
</span><span class="def"> commitAsLookup commit = \case
</span><span class="sub">-    &quot;id&quot; -&gt; Just . toGVal . show . untag . Git.commitOid . commitGit $ commit
</span><span class="sub">-    &quot;href&quot; -&gt; Just . toGVal . (&lt;&gt; &quot;.html&quot;) . show . untag . Git.commitOid . commitGit $ commit
</span><span class="add">+    &quot;id&quot; -&gt; Just . toGVal . commitHash $ commit
</span><span class="add">+    &quot;href&quot; -&gt; Just . toGVal . (&lt;&gt; &quot;.html&quot;) . commitHash $ commit
</span><span class="def">     &quot;title&quot; -&gt; Just . toGVal . T.strip . T.takeWhile (/= &apos;\n&apos;) . Git.commitLog . commitGit $ commit
</span><span class="def">     &quot;body&quot; -&gt; Just . toGVal . T.strip . T.dropWhile (/= &apos;\n&apos;) . Git.commitLog . commitGit $ commit
</span><span class="def">     &quot;message&quot; -&gt; Just . toGVal . T.strip . Git.commitLog . commitGit $ commit
</span></pre>@@ -107,6 +107,9 @@


  <pre><span class="def">     &quot;diffs&quot; -&gt; Just . toGVal . commitDiffs $ commit
</span><span class="def">     _ -&gt; Nothing
</span><span class="def"> 
</span><span class="add">+commitHash :: Commit -&gt; String
</span><span class="add">+commitHash = show . untag . Git.commitOid . commitGit
</span><span class="add">+
</span><span class="def"> {-
</span><span class="def"> With `Diff`s there is a hierarchy:
</span><span class="def"> 
</span></pre></div><div class="diff">
  <p>
    <b>src/Repositories.hs</b>
    <span class="status">Modified</span>
  </p>

  @@ -136,18 +136,25 @@


  <pre><span class="def">                     ensureDir commitDir
</span><span class="def">                     ensureDir fileDir
</span><span class="def"> 
</span><span class="add">+                    -- Check which commits are new since the last run --
</span><span class="add">+                    newCommits &lt;- getUpdates commitDir commits
</span><span class="add">+
</span><span class="def">                     -- Run the generator --
</span><span class="def">                     let quiet = envQuiet env
</span><span class="def">                         force = envForce env
</span><span class="sub">-                        gen = genTarget scope runInIO quiet force
</span><span class="add">+                        gen = genTarget scope runInIO quiet
</span><span class="def"> 
</span><span class="def">                     mapM_ (generate scope runInIO quiet directory) (envRepoTemplates env)
</span><span class="def"> 
</span><span class="def">                     whenJust (envCommitTemplate env) \commitT -&gt; do
</span><span class="sub">-                        mapM_ (gen commitT &quot;commit&quot; commitDir commitHref) commits
</span><span class="add">+                        mapM_ (gen force commitT &quot;commit&quot; commitDir commitHref) newCommits
</span><span class="def"> 
</span><span class="def">                     whenJust (envFileTemplate env) \fileT -&gt; do
</span><span class="sub">-                        mapM_ (gen fileT &quot;file&quot; fileDir fileHref) tree -- TODO: detect file changes
</span><span class="add">+                        if force
</span><span class="add">+                            then mapM_ (gen True fileT &quot;file&quot; fileDir fileHref) tree
</span><span class="add">+                            else
</span><span class="add">+                                let updatedFiles = getUpdatedFiles tree newCommits
</span><span class="add">+                                 in mapM_ (gen True fileT &quot;file&quot; fileDir fileHref) updatedFiles
</span><span class="def"> 
</span><span class="def">                     -- Copy any static files/folders into the output directory --
</span><span class="def">                     envRepoCopyStatics env directory
</span></pre>@@ -348,6 +355,32 @@


  <pre><span class="def">     dropName Nothing _ = Nothing
</span><span class="def"> 
</span><span class="def"> {-
</span><span class="add">+Get the list of commits that need updating since the last run. New commits are
</span><span class="add">+identified by the absence of their output file.
</span><span class="add">+-}
</span><span class="add">+getUpdates :: Path Abs Dir -&gt; [Commit] -&gt; IO [Commit]
</span><span class="add">+getUpdates _ [] = return []
</span><span class="add">+getUpdates directory cs = go cs
</span><span class="add">+  where
</span><span class="add">+    dir = toFilePath directory
</span><span class="add">+
</span><span class="add">+    go :: [Commit] -&gt; IO [Commit]
</span><span class="add">+    go [] = return []
</span><span class="add">+    go (x : xs) =
</span><span class="add">+        ifM
</span><span class="add">+            (D.doesFileExist $ dir FP.&lt;/&gt; commitHref x)
</span><span class="add">+            (return [])
</span><span class="add">+            ((x :) &lt;$&gt; go xs)
</span><span class="add">+
</span><span class="add">+getUpdatedFiles :: [TreeFile] -&gt; [Commit] -&gt; [TreeFile]
</span><span class="add">+getUpdatedFiles [] _ = []
</span><span class="add">+getUpdatedFiles _ [] = []
</span><span class="add">+getUpdatedFiles files commits = filter ((`elem` updated) . treeFilePath) files
</span><span class="add">+  where
</span><span class="add">+    updated :: [T.Text]
</span><span class="add">+    updated = fmap (bsToText . diffNewFile) . concatMap commitDiffs $ commits
</span><span class="add">+
</span><span class="add">+{-
</span><span class="def"> Render repository data into a template and save it to file.
</span><span class="def"> -}
</span><span class="def"> generate ::
</span></pre>@@ -390,7 +423,7 @@


  <pre><span class="def">         TL.writeFile output&apos; =&lt;&lt; render (cbRepoLookup scope&apos; runInIO) template
</span><span class="def"> 
</span><span class="def"> commitHref :: Commit -&gt; FilePath
</span><span class="sub">-commitHref = (++ &quot;.html&quot;) . show . untag . Git.commitOid . commitGit
</span><span class="add">+commitHref = (++ &quot;.html&quot;) . commitHash
</span><span class="def"> 
</span><span class="def"> fileHref :: TreeFile -&gt; FilePath
</span><span class="def"> fileHref = T.unpack . treePathToHref
</span></pre></div>    </div>
  </body>
</html>
