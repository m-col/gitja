<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üêô gitserve - Move data and type code to own module</title>
    <link rel="stylesheet" type="text/css" href="https://gitserve.mcol.xyz/style.css"/>
    <link rel="icon" type="image/png" href="https://gitserve.mcol.xyz/favicon.png"/>
  </head>

  <body>
    <a id="heada" href="https://gitserve.mcol.xyz">
      <header>
        <h1 id="title">gitserve</h1>
        <h2 id="desc">üêô Templated web page generator for your git repositories</h2>
      </header>
    </a>

    <div id="nav">
      <span id="url">git clone <a href="https://github.com/m-col/gitserve">https://github.com/m-col/gitserve</a></span>

      <span id="links">
        <a href="https://gitserve.mcol.xyz">Home</a> |
        <a href="https://gitserve.mcol.xyz/gitserve/log.html">Log</a> |
        <a href="https://gitserve.mcol.xyz/gitserve/tree.html">Files</a> |
        <a href="https://gitserve.mcol.xyz/gitserve/refs.html">Refs</a> |
        <a href="https://gitserve.mcol.xyz/gitserve/file/README.rst.html">Readme</a> |
        <a href="https://gitserve.mcol.xyz/gitserve/file/LICENSE.html">License</a>
      </span>

      <p id="tag">
        Docs built @ <a href="https://gitserve.mcol.xyz/gitserve/commit/2b5e93377bab6ebf38f5e06cebdd49418093d9de.html">2b5e933</a>
      </p>
    </div>

    <div id="content">
      <pre><b>Commit</b> <a href="https://gitserve.mcol.xyz/gitserve/commit/1403669b22b1435f588f71d985db158dc8613f39.html">1403669b22b1435f588f71d985db158dc8613f39</a>
<b>Parent:</b> <a href="https://gitserve.mcol.xyz/gitserve/commit/528d545f3e355e91555265e61ac46de7f93906e7.html">528d545f3e355e91555265e61ac46de7f93906e7</a>
<b>Author:</b> mcol &lt;<a href="mailto:mcol@posteo.net">mcol@posteo.net</a>&gt;
<b>Date:</b> 2021-10-05 22:13:18 +0100
<b>Committer:</b> mcol &lt;<a href="mailto:mcol@posteo.net">mcol@posteo.net</a>&gt;
<b>Committed:</b> 2021-10-05 22:13:18 +0100

Move data and type code to own module

This moves half of the code from Repositories.hs to Types.hs to make
things easier to navigate and read. All of Types.hs is exported (and
only used by Repositories.hs). The warning for no explicit export list
is disabled.
</pre><div class="diff">
  <p>
    <b>stack.yaml</b>
    <span class="status">Modified</span>
  </p>

  @@ -11,6 +11,6 @@


  <pre><span class="def"> # These options are from the Kowainik style guide.
</span><span class="def"> ghc-options:
</span><span class="def">   &quot;$locals&quot;: -Wall -Wcompat -Widentities -Wincomplete-uni-patterns
</span><span class="sub">-    -Wincomplete-record-updates -Wredundant-constraints -Wmissing-export-lists
</span><span class="sub">-    -Wpartial-fields -Wmissing-deriving-strategies -Wunused-packages
</span><span class="sub">-    -fno-warn-unused-do-bind -fno-warn-orphans
</span><span class="add">+    -Wincomplete-record-updates -Wredundant-constraints -Wpartial-fields
</span><span class="add">+    -Wmissing-deriving-strategies -Wunused-packages -fno-warn-unused-do-bind
</span><span class="add">+    -fno-warn-orphans
</span></pre></div><div class="diff">
  <p>
    <b>src/Types.hs</b>
    <span class="status">Added</span>
  </p>

  @@ -0,0 +1,115 @@


  <pre><span class="add">+{-# Language LambdaCase #-}
</span><span class="add">+{-# Language OverloadedStrings #-}
</span><span class="add">+{-# Language FlexibleInstances #-}  -- Needed for `instance ToGVal`
</span><span class="add">+{-# Language MultiParamTypeClasses #-}  -- Needed for `instance ToGVal`
</span><span class="add">+{-# Language InstanceSigs #-}  -- Needed for toGVal type signature
</span><span class="add">+
</span><span class="add">+module Types where
</span><span class="add">+
</span><span class="add">+import Data.Default (def)
</span><span class="add">+import Data.Tagged (untag)
</span><span class="add">+import Data.Text (pack, Text, strip)
</span><span class="add">+import Data.Text.Encoding (decodeUtf8With)
</span><span class="add">+import Data.Text.Encoding.Error (lenientDecode)
</span><span class="add">+import Git
</span><span class="add">+import Git.Libgit2 (LgRepo)
</span><span class="add">+import Text.Ginger.GVal (GVal, toGVal, ToGVal, asText, asHtml, asLookup, asList)
</span><span class="add">+import Text.Ginger.Html (html)
</span><span class="add">+import qualified Data.Text as T
</span><span class="add">+
</span><span class="add">+{-
</span><span class="add">+GVal implementation for `Git.Commit r`, allowing commits to be rendered in Ginger
</span><span class="add">+templates.
</span><span class="add">+-}
</span><span class="add">+instance ToGVal m (Commit LgRepo) where
</span><span class="add">+    toGVal :: Commit LgRepo -&gt; GVal m
</span><span class="add">+    toGVal commit = def
</span><span class="add">+        { asHtml = html . pack . show . commitLog $ commit
</span><span class="add">+        , asText = pack . show . commitLog $ commit
</span><span class="add">+        , asLookup = Just . commitAsLookup $ commit
</span><span class="add">+        }
</span><span class="add">+
</span><span class="add">+commitAsLookup :: Commit LgRepo -&gt; Text -&gt; Maybe (GVal m)
</span><span class="add">+commitAsLookup commit = \case
</span><span class="add">+    &quot;id&quot; -&gt; Just . toGVal . show . untag . commitOid $ commit
</span><span class="add">+    &quot;title&quot; -&gt; Just . toGVal . strip . T.takeWhile (/= &apos;\n&apos;) . commitLog $ commit
</span><span class="add">+    &quot;body&quot; -&gt; Just . toGVal . strip . T.dropWhile (/= &apos;\n&apos;) . commitLog $ commit
</span><span class="add">+    &quot;message&quot; -&gt; Just . toGVal . strip . commitLog $ commit
</span><span class="add">+    &quot;author&quot; -&gt; Just . toGVal . strip . signatureName . commitAuthor $ commit
</span><span class="add">+    &quot;committer&quot; -&gt; Just . toGVal . strip . signatureName . commitCommitter $ commit
</span><span class="add">+    &quot;author_email&quot; -&gt; Just . toGVal . strip . signatureEmail . commitAuthor $ commit
</span><span class="add">+    &quot;committer_email&quot; -&gt; Just . toGVal . strip . signatureEmail . commitCommitter $ commit
</span><span class="add">+    &quot;authored&quot; -&gt; Just . toGVal . show . signatureWhen . commitAuthor $ commit
</span><span class="add">+    &quot;committed&quot; -&gt; Just . toGVal . show . signatureWhen . commitCommitter $ commit
</span><span class="add">+    &quot;encoding&quot; -&gt; Just . toGVal . strip . commitEncoding $ commit
</span><span class="add">+    _ -&gt; Nothing
</span><span class="add">+
</span><span class="add">+{-
</span><span class="add">+Next we have some data used to represent a repository&apos;s tree and the different kinds of
</span><span class="add">+objects contained therein.
</span><span class="add">+-}
</span><span class="add">+data TreeFile = TreeFile
</span><span class="add">+    { treeFilePath :: TreeFilePath
</span><span class="add">+    , treeFileContents :: TreeFileContents
</span><span class="add">+    }
</span><span class="add">+
</span><span class="add">+data TreeFileContents = FileContents (TreeEntryMode, Text) | FolderContents [TreeFilePath]
</span><span class="add">+
</span><span class="add">+data TreeEntryMode = ModeDirectory | ModePlain | ModeExecutable | ModeSymlink | ModeSubmodule
</span><span class="add">+
</span><span class="add">+{-
</span><span class="add">+Some helper functions to convert from Haskell&apos;s LibGit2 BlobKind to our TreeEntryMode,
</span><span class="add">+and then from that to Git&apos;s octal representation, as seen when calling `git ls-tree
</span><span class="add">+&lt;tree-ish&gt;`
</span><span class="add">+-}
</span><span class="add">+blobkindToMode :: BlobKind -&gt; TreeEntryMode
</span><span class="add">+blobkindToMode PlainBlob = ModePlain
</span><span class="add">+blobkindToMode ExecutableBlob = ModeExecutable
</span><span class="add">+blobkindToMode SymlinkBlob = ModeSymlink
</span><span class="add">+
</span><span class="add">+modeToOctal :: TreeEntryMode -&gt; String
</span><span class="add">+modeToOctal ModeDirectory = &quot;40000&quot;
</span><span class="add">+modeToOctal ModePlain = &quot;00644&quot;
</span><span class="add">+modeToOctal ModeExecutable = &quot;00755&quot;
</span><span class="add">+modeToOctal ModeSymlink = &quot;20000&quot;
</span><span class="add">+modeToOctal ModeSubmodule = &quot;60000&quot;
</span><span class="add">+
</span><span class="add">+{-
</span><span class="add">+GVal implementations for data definitions above, allowing commits to be rendered in
</span><span class="add">+Ginger templates.
</span><span class="add">+-}
</span><span class="add">+instance ToGVal m TreeFile where
</span><span class="add">+    toGVal :: TreeFile -&gt; GVal m
</span><span class="add">+    toGVal treefile = def
</span><span class="add">+        { asHtml = html . pack . show . treeFilePath $ treefile
</span><span class="add">+        , asText = pack . show . treeFilePath $ treefile
</span><span class="add">+        , asLookup = Just . treeAsLookup $ treefile
</span><span class="add">+        }
</span><span class="add">+
</span><span class="add">+instance ToGVal m TreeFileContents where
</span><span class="add">+    toGVal :: TreeFileContents -&gt; GVal m
</span><span class="add">+    toGVal (FileContents (_, text)) = toGVal text
</span><span class="add">+    toGVal (FolderContents filePaths) = def
</span><span class="add">+        { asHtml = html . pack . show $ filePaths
</span><span class="add">+        , asText = pack . show $ filePaths
</span><span class="add">+        , asList = Just . fmap toGVal $ filePaths
</span><span class="add">+        }
</span><span class="add">+
</span><span class="add">+treeAsLookup :: TreeFile -&gt; Text -&gt; Maybe (GVal m)
</span><span class="add">+treeAsLookup treefile = \case
</span><span class="add">+    &quot;path&quot; -&gt; Just . toGVal . treeFilePath $ treefile
</span><span class="add">+    &quot;href&quot; -&gt; Just . toGVal . treePathToHref . treeFilePath $ treefile
</span><span class="add">+    &quot;contents&quot; -&gt; Just . toGVal . treeFileContents $ treefile
</span><span class="add">+    &quot;is_directory&quot; -&gt; Just . toGVal . treeFileIsDirectory $ treefile
</span><span class="add">+    _ -&gt; Nothing
</span><span class="add">+
</span><span class="add">+treeFileIsDirectory :: TreeFile -&gt; Bool
</span><span class="add">+treeFileIsDirectory treefile = case treeFileContents treefile of
</span><span class="add">+    FileContents _ -&gt; False
</span><span class="add">+    FolderContents _ -&gt; True
</span><span class="add">+
</span><span class="add">+{-
</span><span class="add">+Get the name of a tree file path&apos;s HTML file.
</span><span class="add">+-}
</span><span class="add">+treePathToHref :: TreeFilePath -&gt; Text
</span><span class="add">+treePathToHref = flip T.append &quot;.html&quot; . T.replace &quot;/&quot; &quot;.&quot; .  decodeUtf8With lenientDecode
</span></pre></div><div class="diff">
  <p>
    <b>src/Repositories.hs</b>
    <span class="status">Modified</span>
  </p>

  @@ -1,8 +1,6 @@


  <pre><span class="def"> {-# Language LambdaCase #-}
</span><span class="def"> {-# Language OverloadedStrings #-}
</span><span class="sub">-{-# Language FlexibleInstances #-}  -- Needed for `instance ToGVal`
</span><span class="sub">-{-# Language MultiParamTypeClasses #-}  -- Needed for `instance ToGVal`
</span><span class="sub">-{-# Language InstanceSigs #-}  -- Needed for toGVal type signature
</span><span class="add">+{-# Language FlexibleInstances #-}  -- Needed for the Target class type constraints
</span><span class="def"> {-# Language FlexibleContexts #-}  -- Needed for the Target class type constraints
</span><span class="def"> 
</span><span class="def"> module Repositories (
</span></pre>@@ -14,10 +12,9 @@


  <pre><span class="def"> import Control.Monad ((&lt;=&lt;))
</span><span class="def"> import Control.Monad.IO.Class (liftIO)
</span><span class="def"> import Control.Monad.Trans.Reader (ReaderT)
</span><span class="sub">-import Data.Default (def)
</span><span class="def"> import Data.Either (fromRight)
</span><span class="def"> import Data.Tagged
</span><span class="sub">-import Data.Text (pack, unpack, Text, strip)
</span><span class="add">+import Data.Text (pack, unpack, Text)
</span><span class="def"> import Data.Text.Encoding (decodeUtf8With)
</span><span class="def"> import Data.Text.Encoding.Error (lenientDecode)
</span><span class="def"> import Data.Maybe (mapMaybe)
</span></pre>@@ -26,15 +23,15 @@


  <pre><span class="def"> import System.Directory (createDirectoryIfMissing)
</span><span class="def"> import System.FilePath ((&lt;/&gt;), takeFileName)
</span><span class="def"> import System.IO.Error (tryIOError)
</span><span class="sub">-import Text.Ginger.GVal (GVal, toGVal, ToGVal, asText, asHtml, asLookup, asList)
</span><span class="sub">-import Text.Ginger.Html (Html, html)
</span><span class="add">+import Text.Ginger.GVal (GVal, toGVal, ToGVal)
</span><span class="add">+import Text.Ginger.Html (Html)
</span><span class="def"> import Text.Ginger.Run (Run)
</span><span class="def"> import Text.Ginger.Parse (SourcePos)
</span><span class="def"> import qualified Data.HashMap.Strict as HashMap
</span><span class="sub">-import qualified Data.Text as T
</span><span class="def"> 
</span><span class="def"> import Config
</span><span class="def"> import Templates
</span><span class="add">+import Types
</span><span class="def"> 
</span><span class="def"> {-
</span><span class="def"> This is the entrypoint that receives the ``Config`` and uses it to map over our
</span></pre>@@ -47,7 +44,7 @@


  <pre><span class="def">     return ()
</span><span class="def"> 
</span><span class="def"> {-
</span><span class="sub">-Pass the repository&apos;s folder, get its description. This is export so that Index.hs can
</span><span class="add">+Pass the repository&apos;s folder, get its description. This is exported so that Index.hs can
</span><span class="def"> use it too.
</span><span class="def"> -}
</span><span class="def"> getDescription :: FilePath -&gt; IO Text
</span></pre>@@ -122,28 +119,6 @@


  <pre><span class="def"> loadCommit (CommitObjOid oid) = Just $ lookupCommit oid
</span><span class="def"> loadCommit _ = Nothing
</span><span class="def"> 
</span><span class="sub">-{-
</span><span class="sub">-Valid modes:
</span><span class="sub">-040000 Directory
</span><span class="sub">-100644 Regular non-executable file
</span><span class="sub">-100755 Regular executable file
</span><span class="sub">-120000 Symbolic link
</span><span class="sub">-160000 Submodule
</span><span class="sub">--}
</span><span class="sub">-data TreeEntryMode = ModeDirectory | ModePlain | ModeExecutable | ModeSymlink | ModeSubmodule
</span><span class="sub">-
</span><span class="sub">-toMode :: BlobKind -&gt; TreeEntryMode
</span><span class="sub">-toMode PlainBlob = ModePlain
</span><span class="sub">-toMode ExecutableBlob = ModeExecutable
</span><span class="sub">-toMode SymlinkBlob = ModeSymlink
</span><span class="sub">-
</span><span class="sub">-data TreeFileContents = FileContents (TreeEntryMode, Text) | FolderContents [TreeFilePath]
</span><span class="sub">-
</span><span class="sub">-data TreeFile = TreeFile
</span><span class="sub">-    { treeFilePath :: TreeFilePath
</span><span class="sub">-    , treeFileContents :: TreeFileContents
</span><span class="sub">-    }
</span><span class="sub">-
</span><span class="def"> getTree :: CommitOid LgRepo -&gt; ReaderT LgRepo IO [TreeFile]
</span><span class="def"> getTree commitID = do
</span><span class="def">     entries &lt;- listTreeEntries =&lt;&lt; lookupTree . commitTree =&lt;&lt; lookupCommit commitID
</span></pre>@@ -152,78 +127,12 @@


  <pre><span class="def"> 
</span><span class="def"> gvalTreeEntry :: TreeEntry LgRepo -&gt; ReaderT LgRepo IO TreeFileContents
</span><span class="def"> gvalTreeEntry (BlobEntry oid kind) =
</span><span class="sub">-    FileContents . (,) (toMode kind) . decodeUtf8With lenientDecode &lt;$&gt; catBlob oid
</span><span class="add">+    FileContents . (,) (blobkindToMode kind) . decodeUtf8With lenientDecode &lt;$&gt; catBlob oid
</span><span class="def"> gvalTreeEntry (TreeEntry oid) = FolderContents . fmap fst &lt;$&gt; (listTreeEntries =&lt;&lt; lookupTree oid)
</span><span class="def"> gvalTreeEntry (CommitEntry _) = return . FileContents $ (ModeSubmodule, &quot;No contents&quot;)  -- TODO
</span><span class="def"> 
</span><span class="sub">-
</span><span class="sub">-{-
</span><span class="sub">-Here we define how commits can be accessed and represented in Ginger templates.
</span><span class="sub">--}
</span><span class="sub">-instance ToGVal m (Commit LgRepo) where
</span><span class="sub">-    toGVal :: Commit LgRepo -&gt; GVal m
</span><span class="sub">-    toGVal commit = def
</span><span class="sub">-        { asHtml = html . pack . show . commitLog $ commit
</span><span class="sub">-        , asText = pack . show . commitLog $ commit
</span><span class="sub">-        , asLookup = Just . commitAsLookup $ commit
</span><span class="sub">-        }
</span><span class="sub">-
</span><span class="sub">-commitAsLookup :: Commit LgRepo -&gt; Text -&gt; Maybe (GVal m)
</span><span class="sub">-commitAsLookup commit = \case
</span><span class="sub">-    &quot;id&quot; -&gt; Just . toGVal . show . untag . commitOid $ commit
</span><span class="sub">-    &quot;title&quot; -&gt; Just . toGVal . strip . T.takeWhile (/= &apos;\n&apos;) . commitLog $ commit
</span><span class="sub">-    &quot;body&quot; -&gt; Just . toGVal . strip . T.dropWhile (/= &apos;\n&apos;) . commitLog $ commit
</span><span class="sub">-    &quot;message&quot; -&gt; Just . toGVal . strip . commitLog $ commit
</span><span class="sub">-    &quot;author&quot; -&gt; Just . toGVal . strip . signatureName . commitAuthor $ commit
</span><span class="sub">-    &quot;committer&quot; -&gt; Just . toGVal . strip . signatureName . commitCommitter $ commit
</span><span class="sub">-    &quot;author_email&quot; -&gt; Just . toGVal . strip . signatureEmail . commitAuthor $ commit
</span><span class="sub">-    &quot;committer_email&quot; -&gt; Just . toGVal . strip . signatureEmail . commitCommitter $ commit
</span><span class="sub">-    &quot;authored&quot; -&gt; Just . toGVal . show . signatureWhen . commitAuthor $ commit
</span><span class="sub">-    &quot;committed&quot; -&gt; Just . toGVal . show . signatureWhen . commitCommitter $ commit
</span><span class="sub">-    &quot;encoding&quot; -&gt; Just . toGVal . strip . commitEncoding $ commit
</span><span class="sub">-    _ -&gt; Nothing
</span><span class="sub">-
</span><span class="sub">-
</span><span class="sub">-{-
</span><span class="sub">-Here we define how files in the tree can be accessed by Ginger templates.
</span><span class="sub">--}
</span><span class="sub">-instance ToGVal m TreeFile where
</span><span class="sub">-    toGVal :: TreeFile -&gt; GVal m
</span><span class="sub">-    toGVal treefile = def
</span><span class="sub">-        { asHtml = html . pack . show . treeFilePath $ treefile
</span><span class="sub">-        , asText = pack . show . treeFilePath $ treefile
</span><span class="sub">-        , asLookup = Just . treeAsLookup $ treefile
</span><span class="sub">-        }
</span><span class="sub">-
</span><span class="sub">-instance ToGVal m TreeFileContents where
</span><span class="sub">-    toGVal :: TreeFileContents -&gt; GVal m
</span><span class="sub">-    toGVal (FileContents (_, text)) = toGVal text
</span><span class="sub">-    toGVal (FolderContents filePaths) = def
</span><span class="sub">-        { asHtml = html . pack . show $ filePaths
</span><span class="sub">-        , asText = pack . show $ filePaths
</span><span class="sub">-        , asList = Just . fmap toGVal $ filePaths
</span><span class="sub">-        }
</span><span class="sub">-
</span><span class="sub">-treeAsLookup :: TreeFile -&gt; Text -&gt; Maybe (GVal m)
</span><span class="sub">-treeAsLookup treefile = \case
</span><span class="sub">-    &quot;path&quot; -&gt; Just . toGVal . treeFilePath $ treefile
</span><span class="sub">-    &quot;href&quot; -&gt; Just . toGVal . treePathToHref . treeFilePath $ treefile
</span><span class="sub">-    &quot;contents&quot; -&gt; Just . toGVal . treeFileContents $ treefile
</span><span class="sub">-    &quot;is_directory&quot; -&gt; Just . toGVal . treeFileIsDirectory $ treefile
</span><span class="sub">-    _ -&gt; Nothing
</span><span class="sub">-
</span><span class="sub">-treeFileIsDirectory :: TreeFile -&gt; Bool
</span><span class="sub">-treeFileIsDirectory treefile = case treeFileContents treefile of
</span><span class="sub">-    FileContents _ -&gt; False
</span><span class="sub">-    FolderContents _ -&gt; True
</span><span class="sub">-
</span><span class="sub">-{-
</span><span class="sub">-Get the name of a tree file path&apos;s HTML file.
</span><span class="sub">--}
</span><span class="sub">-treePathToHref :: TreeFilePath -&gt; Text
</span><span class="sub">-treePathToHref = flip T.append &quot;.html&quot; . T.replace &quot;/&quot; &quot;.&quot; .  decodeUtf8With lenientDecode
</span><span class="sub">-
</span><span class="def"> ----------------------------------------------------------------------------------------
</span><span class="add">+-- Targets -----------------------------------------------------------------------------
</span><span class="def"> 
</span><span class="def"> {-
</span><span class="def"> A Target refers to a template scope and repository object whose information is available
</span></pre></div><div class="diff">
  <p>
    <b>gitserve.cabal</b>
    <span class="status">Modified</span>
  </p>

  @@ -16,7 +16,7 @@


  <pre><span class="def"> executable gitserve
</span><span class="def">   hs-source-dirs:      src
</span><span class="def">   main-is:             Main.hs
</span><span class="sub">-  other-modules:       Config, Index, Repositories, Templates
</span><span class="add">+  other-modules:       Config, Index, Repositories, Templates, Types
</span><span class="def">   default-language:    Haskell2010
</span><span class="def">   build-depends:       base &gt;= 4.7 &amp;&amp; &lt; 5
</span><span class="def">                      , conduit
</span></pre></div>    </div>
  </body>
</html>
