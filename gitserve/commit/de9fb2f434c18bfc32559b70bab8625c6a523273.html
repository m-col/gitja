<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üêô gitserve - Expose commit diff data to templates</title>
    <link rel="stylesheet" type="text/css" href="https://gitserve.mcol.xyz/style.css"/>
    <link rel="icon" type="image/png" href="https://gitserve.mcol.xyz/favicon.png"/>
  </head>

  <body>
    <a id="heada" href="https://gitserve.mcol.xyz">
      <header>
        <h1 id="title">gitserve</h1>
        <h2 id="desc">üêô Templated web page generator for your git repositories</h2>
      </header>
    </a>

    <div id="nav">
      <span id="url">git clone <a href="https://github.com/m-col/gitserve">https://github.com/m-col/gitserve</a></span>

      <span id="links">
        <a href="https://gitserve.mcol.xyz">Home</a> |
        <a href="https://gitserve.mcol.xyz/gitserve/log.html">Log</a> |
        <a href="https://gitserve.mcol.xyz/gitserve/tree.html">Files</a> |
        <a href="https://gitserve.mcol.xyz/gitserve/refs.html">Refs</a> |
        <a href="https://gitserve.mcol.xyz/gitserve/file/README.rst.html">Readme</a> |
        <a href="https://gitserve.mcol.xyz/gitserve/file/LICENSE.html">License</a>
      </span>

      <p id="tag">
        Docs built @ <a href="https://gitserve.mcol.xyz/gitserve/commit/829fa1cb62b3e97d5953cb91fb2a9bb6e9d5581e.html">829fa1c</a>
      </p>
    </div>

    <div id="content">
      <pre><b>Commit</b> <a href="https://gitserve.mcol.xyz/gitserve/commit/de9fb2f434c18bfc32559b70bab8625c6a523273.html">de9fb2f434c18bfc32559b70bab8625c6a523273</a>
<b>Parent:</b> <a href="https://gitserve.mcol.xyz/gitserve/commit/eaba24c375b39cc85b6ae12d027983df2c78183f.html">eaba24c375b39cc85b6ae12d027983df2c78183f</a>
<b>Author:</b> mcol &lt;<a href="mailto:mcol@posteo.net">mcol@posteo.net</a>&gt;
<b>Date:</b> 2021-12-07 00:55:53 +0300
<b>Committer:</b> mcol &lt;<a href="mailto:mcol@posteo.net">mcol@posteo.net</a>&gt;
<b>Committed:</b> 2021-12-07 00:55:53 +0300

Expose commit diff data to templates
</pre><div class="diff">
  <p>
    <b>templates/docs/style.css</b>
    <span class="status">Modified</span>
  </p>

  @@ -98,7 +98,6 @@


  <pre><span class="def">     border-collapse: collapse;
</span><span class="def"> }
</span><span class="def"> 
</span><span class="sub">-
</span><span class="def"> th {
</span><span class="def">     background-color: #fcfaff;
</span><span class="def">     text-decoration: underline #aaa;
</span></pre>@@ -117,3 +116,23 @@


  <pre><span class="def">     background-color: #5d479d50;
</span><span class="def">     color: #333;
</span><span class="def"> }
</span><span class="add">+
</span><span class="add">+.diff {
</span><span class="add">+    background-color: #eee;
</span><span class="add">+    padding: 0.6em;
</span><span class="add">+    overflow-x: scroll;
</span><span class="add">+    margin: 20px 0;
</span><span class="add">+}
</span><span class="add">+
</span><span class="add">+.diff .status {
</span><span class="add">+    color: #666;
</span><span class="add">+    float: right;
</span><span class="add">+}
</span><span class="add">+
</span><span class="add">+.diff .add {
</span><span class="add">+    color: #0a0;
</span><span class="add">+}
</span><span class="add">+
</span><span class="add">+.diff .sub {
</span><span class="add">+    color: #a00;
</span><span class="add">+}
</span></pre></div><div class="diff">
  <p>
    <b>templates/docs/repo/commit.html</b>
    <span class="status">Modified</span>
  </p>

  @@ -12,4 +12,29 @@


  <pre><span class="def"> 
</span><span class="def"> {{ commit.message }}
</span><span class="def"> &lt;/pre&gt;
</span><span class="add">+
</span><span class="add">+{%- for diff in commit.diff -%}
</span><span class="add">+&lt;div class=&quot;diff&quot;&gt;
</span><span class="add">+  &lt;p&gt;
</span><span class="add">+    &lt;b&gt;{{ diff.new_file }}&lt;/b&gt;
</span><span class="add">+    &lt;span class=&quot;status&quot;&gt;{{ diff.status }}&lt;/span&gt;
</span><span class="add">+  &lt;/p&gt;
</span><span class="add">+
</span><span class="add">+  {% if diff.newfile != diff.oldfile %}
</span><span class="add">+  &lt;p&gt;Renamed from {{ diff.old_file }}&lt;/p&gt;
</span><span class="add">+  {% endif %}
</span><span class="add">+
</span><span class="add">+  {%- for hunk in diff.hunks -%}
</span><span class="add">+  {{ hunk.header }}
</span><span class="add">+
</span><span class="add">+  &lt;pre&gt;
</span><span class="add">+    {%- for line in hunk.lines -%}
</span><span class="add">+      &lt;span class=&quot;{{ line.class }}&quot;&gt;{{ line.text }}&lt;/span&gt;
</span><span class="add">+    {%- endfor -%}
</span><span class="add">+  &lt;/pre&gt;
</span><span class="add">+
</span><span class="add">+  {%- endfor -%}
</span><span class="add">+&lt;/div&gt;
</span><span class="add">+{%- endfor -%}
</span><span class="add">+
</span><span class="def"> {% endblock %}
</span></pre></div><div class="diff">
  <p>
    <b>src/Types.hs</b>
    <span class="status">Modified</span>
  </p>

  @@ -15,6 +15,7 @@


  <pre><span class="def"> import Control.Monad.Catch (throwM)
</span><span class="def"> import Control.Monad.IO.Class (liftIO)
</span><span class="def"> import Control.Monad.Trans.Reader (ReaderT)
</span><span class="add">+import Data.ByteString (ByteString)
</span><span class="def"> import Data.Default (def)
</span><span class="def"> import Data.Maybe (fromMaybe, listToMaybe)
</span><span class="def"> import Data.Tagged (untag)
</span></pre>@@ -38,6 +39,12 @@


  <pre><span class="def"> -}
</span><span class="def"> type RunRepo = Run SourcePos (ReaderT LgRepo IO) Html
</span><span class="def"> 
</span><span class="add">+unquote :: String -&gt; String
</span><span class="add">+unquote = init . tail
</span><span class="add">+
</span><span class="add">+bsToText :: ByteString -&gt; Text
</span><span class="add">+bsToText = decodeUtf8With lenientDecode
</span><span class="add">+
</span><span class="def"> {-
</span><span class="def"> GVal implementation for a repository, accessed in the scope of an individual repository,
</span><span class="def"> as well as in a list of all repositories in the index template.
</span></pre>@@ -45,7 +52,7 @@


  <pre><span class="def"> data Repo = Repo
</span><span class="def">     { repositoryPath :: Path Abs Dir
</span><span class="def">     , repositoryDescription :: Text
</span><span class="sub">-    , repositoryHead :: Maybe (Git.Commit LgRepo)
</span><span class="add">+    , repositoryHead :: Maybe Commit
</span><span class="def">     }
</span><span class="def"> 
</span><span class="def"> instance ToGVal m (Path b t) where
</span></pre>@@ -61,45 +68,121 @@


  <pre><span class="def">             , asLookup = Just . repoAsLookup $ repo
</span><span class="def">             }
</span><span class="def"> 
</span><span class="sub">-unquote :: String -&gt; String
</span><span class="sub">-unquote = init . tail
</span><span class="sub">-
</span><span class="def"> repoAsLookup :: Repo -&gt; Text -&gt; Maybe (GVal m)
</span><span class="def"> repoAsLookup repo = \case
</span><span class="def">     &quot;name&quot; -&gt; Just . toGVal . init . unquote . show . dirname . repositoryPath $ repo
</span><span class="def">     &quot;description&quot; -&gt; Just . toGVal . repositoryDescription $ repo
</span><span class="def">     &quot;head&quot; -&gt; Just . toGVal . repositoryHead $ repo
</span><span class="sub">-    &quot;updated&quot; -&gt; toGVal . show . Git.signatureWhen . Git.commitCommitter &lt;$&gt; repositoryHead repo
</span><span class="add">+    &quot;updated&quot; -&gt; toGVal . show . Git.signatureWhen . Git.commitCommitter . commitGit &lt;$&gt; repositoryHead repo
</span><span class="def">     _ -&gt; Nothing
</span><span class="def"> 
</span><span class="def"> {-
</span><span class="sub">-GVal implementation for `Git.Commit r`, allowing commits to be rendered in Ginger
</span><span class="sub">-templates.
</span><span class="add">+GVal implementation for commits, allowing them to be rendered in Ginger templates.
</span><span class="def"> -}
</span><span class="sub">-instance ToGVal m (Git.Commit LgRepo) where
</span><span class="sub">-    toGVal :: Git.Commit LgRepo -&gt; GVal m
</span><span class="add">+data Commit = Commit
</span><span class="add">+    { commitGit :: Git.Commit LgRepo
</span><span class="add">+    , commitDiffs :: [Git.Diff]
</span><span class="add">+    }
</span><span class="add">+
</span><span class="add">+instance ToGVal m Commit where
</span><span class="add">+    toGVal :: Commit -&gt; GVal m
</span><span class="def">     toGVal commit =
</span><span class="def">         def
</span><span class="sub">-            { asHtml = html . strip . T.takeWhile (/= &apos;\n&apos;) . Git.commitLog $ commit
</span><span class="sub">-            , asText = pack . show . Git.commitLog $ commit
</span><span class="add">+            { asHtml = html . strip . T.takeWhile (/= &apos;\n&apos;) . Git.commitLog . commitGit $ commit
</span><span class="add">+            , asText = pack . show . Git.commitLog . commitGit $ commit
</span><span class="def">             , asLookup = Just . commitAsLookup $ commit
</span><span class="def">             }
</span><span class="def"> 
</span><span class="sub">-commitAsLookup :: Git.Commit LgRepo -&gt; Text -&gt; Maybe (GVal m)
</span><span class="add">+commitAsLookup :: Commit -&gt; Text -&gt; Maybe (GVal m)
</span><span class="def"> commitAsLookup commit = \case
</span><span class="sub">-    &quot;id&quot; -&gt; Just . toGVal . show . untag . Git.commitOid $ commit
</span><span class="sub">-    &quot;href&quot; -&gt; Just . toGVal . (&lt;&gt; &quot;.html&quot;) . show . untag . Git.commitOid $ commit
</span><span class="sub">-    &quot;title&quot; -&gt; Just . toGVal . strip . T.takeWhile (/= &apos;\n&apos;) . Git.commitLog $ commit
</span><span class="sub">-    &quot;body&quot; -&gt; Just . toGVal . strip . T.dropWhile (/= &apos;\n&apos;) . Git.commitLog $ commit
</span><span class="sub">-    &quot;message&quot; -&gt; Just . toGVal . strip . Git.commitLog $ commit
</span><span class="sub">-    &quot;author&quot; -&gt; Just . toGVal . strip . Git.signatureName . Git.commitAuthor $ commit
</span><span class="sub">-    &quot;committer&quot; -&gt; Just . toGVal . strip . Git.signatureName . Git.commitCommitter $ commit
</span><span class="sub">-    &quot;author_email&quot; -&gt; Just . toGVal . strip . Git.signatureEmail . Git.commitAuthor $ commit
</span><span class="sub">-    &quot;committer_email&quot; -&gt; Just . toGVal . strip . Git.signatureEmail . Git.commitCommitter $ commit
</span><span class="sub">-    &quot;authored&quot; -&gt; Just . toGVal . show . Git.signatureWhen . Git.commitAuthor $ commit
</span><span class="sub">-    &quot;committed&quot; -&gt; Just . toGVal . show . Git.signatureWhen . Git.commitCommitter $ commit
</span><span class="sub">-    &quot;encoding&quot; -&gt; Just . toGVal . strip . Git.commitEncoding $ commit
</span><span class="sub">-    &quot;parent&quot; -&gt; toGVal . show . untag &lt;$&gt; (listToMaybe . Git.commitParents $ commit)
</span><span class="add">+    &quot;id&quot; -&gt; Just . toGVal . show . untag . Git.commitOid . commitGit $ commit
</span><span class="add">+    &quot;href&quot; -&gt; Just . toGVal . (&lt;&gt; &quot;.html&quot;) . show . untag . Git.commitOid . commitGit $ commit
</span><span class="add">+    &quot;title&quot; -&gt; Just . toGVal . strip . T.takeWhile (/= &apos;\n&apos;) . Git.commitLog . commitGit $ commit
</span><span class="add">+    &quot;body&quot; -&gt; Just . toGVal . strip . T.dropWhile (/= &apos;\n&apos;) . Git.commitLog . commitGit $ commit
</span><span class="add">+    &quot;message&quot; -&gt; Just . toGVal . strip . Git.commitLog . commitGit $ commit
</span><span class="add">+    &quot;author&quot; -&gt; Just . toGVal . strip . Git.signatureName . Git.commitAuthor . commitGit $ commit
</span><span class="add">+    &quot;committer&quot; -&gt; Just . toGVal . strip . Git.signatureName . Git.commitCommitter . commitGit $ commit
</span><span class="add">+    &quot;author_email&quot; -&gt; Just . toGVal . strip . Git.signatureEmail . Git.commitAuthor . commitGit $ commit
</span><span class="add">+    &quot;committer_email&quot; -&gt; Just . toGVal . strip . Git.signatureEmail . Git.commitCommitter . commitGit $ commit
</span><span class="add">+    &quot;authored&quot; -&gt; Just . toGVal . show . Git.signatureWhen . Git.commitAuthor . commitGit $ commit
</span><span class="add">+    &quot;committed&quot; -&gt; Just . toGVal . show . Git.signatureWhen . Git.commitCommitter . commitGit $ commit
</span><span class="add">+    &quot;encoding&quot; -&gt; Just . toGVal . strip . Git.commitEncoding . commitGit $ commit
</span><span class="add">+    &quot;parent&quot; -&gt; toGVal . show . untag &lt;$&gt; (listToMaybe . Git.commitParents . commitGit $ commit)
</span><span class="add">+    &quot;diff&quot; -&gt; Just . toGVal . commitDiffs $ commit
</span><span class="add">+    _ -&gt; Nothing
</span><span class="add">+
</span><span class="add">+{-
</span><span class="add">+With `Diff`s there is a hierarchy:
</span><span class="add">+
</span><span class="add">+- A commit has multiple diffs - one per file that changed.
</span><span class="add">+- Each diff has 1 or more hunks
</span><span class="add">+- Each hunk has a number of lines
</span><span class="add">+-}
</span><span class="add">+instance ToGVal m Git.Diff where
</span><span class="add">+    toGVal :: Git.Diff -&gt; GVal m
</span><span class="add">+    toGVal diff =
</span><span class="add">+        def
</span><span class="add">+            { asHtml = html . bsToText . Git.diffNewFile $ diff
</span><span class="add">+            , asText = bsToText . Git.diffNewFile $ diff
</span><span class="add">+            , asLookup = Just . diffAsLookup $ diff
</span><span class="add">+            }
</span><span class="add">+
</span><span class="add">+diffAsLookup :: Git.Diff -&gt; Text -&gt; Maybe (GVal m)
</span><span class="add">+diffAsLookup diff = \case
</span><span class="add">+    &quot;new_file&quot; -&gt; Just . toGVal . Git.diffNewFile $ diff
</span><span class="add">+    &quot;old_file&quot; -&gt; toGVal &lt;$&gt; Git.diffOldFile diff
</span><span class="add">+    &quot;status&quot; -&gt; Just . toGVal . drop 5 . show . Git.diffStatus $ diff
</span><span class="add">+    &quot;hunks&quot; -&gt; Just . toGVal . Git.diffHunks $ diff
</span><span class="add">+    _ -&gt; Nothing
</span><span class="add">+
</span><span class="add">+instance ToGVal m Git.Hunk where
</span><span class="add">+    toGVal :: Git.Hunk -&gt; GVal m
</span><span class="add">+    toGVal hunk =
</span><span class="add">+        def
</span><span class="add">+            { asHtml = html . bsToText . Git.hunkHeader $ hunk
</span><span class="add">+            , asText = bsToText . Git.hunkHeader $ hunk
</span><span class="add">+            , asLookup = Just . hunkAsLookup $ hunk
</span><span class="add">+            }
</span><span class="add">+
</span><span class="add">+hunkAsLookup :: Git.Hunk -&gt; Text -&gt; Maybe (GVal m)
</span><span class="add">+hunkAsLookup hunk = \case
</span><span class="add">+    &quot;lines&quot; -&gt; Just . toGVal . fmap makeLine . Git.hunkLines $ hunk
</span><span class="add">+    &quot;header&quot; -&gt; Just . toGVal . bsToText . Git.hunkHeader $ hunk
</span><span class="add">+    _ -&gt; Nothing
</span><span class="add">+
</span><span class="add">+{-
</span><span class="add">+Wrap diff lines when accessed so that they can each get a class string indicating
</span><span class="add">+whether they are additions, subtractions, or context lines. They are primarily a
</span><span class="add">+convenience for assigning CSS classes.
</span><span class="add">+-}
</span><span class="add">+data Line = Line
</span><span class="add">+    { lineText :: Text
</span><span class="add">+    , lineClass :: String
</span><span class="add">+    }
</span><span class="add">+
</span><span class="add">+makeLine :: Git.DiffLine -&gt; Line
</span><span class="add">+makeLine line = Line text (cls . T.head $ text)
</span><span class="add">+  where
</span><span class="add">+    text = bsToText line
</span><span class="add">+    cls :: Char -&gt; String
</span><span class="add">+    cls = \case
</span><span class="add">+        &apos;+&apos; -&gt; &quot;add&quot;
</span><span class="add">+        &apos;-&apos; -&gt; &quot;sub&quot;
</span><span class="add">+        _ -&gt; &quot;def&quot;
</span><span class="add">+
</span><span class="add">+instance ToGVal m Line where
</span><span class="add">+    toGVal :: Line -&gt; GVal m
</span><span class="add">+    toGVal line =
</span><span class="add">+        def
</span><span class="add">+            { asHtml = html . lineText $ line
</span><span class="add">+            , asText = lineText line
</span><span class="add">+            , asLookup = Just . lineAsLookup $ line
</span><span class="add">+            }
</span><span class="add">+
</span><span class="add">+lineAsLookup :: Line -&gt; Text -&gt; Maybe (GVal m)
</span><span class="add">+lineAsLookup line = \case
</span><span class="add">+    &quot;text&quot; -&gt; Just . toGVal . lineText $ line
</span><span class="add">+    &quot;class&quot; -&gt; Just . toGVal . lineClass $ line
</span><span class="def">     _ -&gt; Nothing
</span><span class="def"> 
</span><span class="def"> {-
</span></pre>@@ -157,7 +240,7 @@


  <pre><span class="def"> 
</span><span class="def">     if toEnum . fromEnum $ isBinary -- This reads weird, but it goes CInt, to Int, to Bool.
</span><span class="def">         then return BinaryContents
</span><span class="sub">-        else FileContents . decodeUtf8With lenientDecode &lt;$&gt; Git.catBlob oid
</span><span class="add">+        else FileContents . bsToText &lt;$&gt; Git.catBlob oid
</span><span class="def"> 
</span><span class="def"> {-
</span><span class="def"> GVal implementations for data definitions above, allowing commits to be rendered in
</span></pre>@@ -230,7 +313,7 @@


  <pre><span class="def"> -}
</span><span class="def"> data Ref = Ref
</span><span class="def">     { refName :: Git.RefName
</span><span class="sub">-    , refCommit :: Git.Commit LgRepo
</span><span class="add">+    , refCommit :: Commit
</span><span class="def">     }
</span><span class="def"> 
</span><span class="def"> instance ToGVal RunRepo Ref where
</span></pre></div><div class="diff">
  <p>
    <b>src/Repositories.hs</b>
    <span class="status">Modified</span>
  </p>

  @@ -17,7 +17,7 @@


  <pre><span class="def"> import Control.Monad.Trans.Reader (ReaderT)
</span><span class="def"> import Data.Either (isRight)
</span><span class="def"> import qualified Data.HashMap.Strict as HashMap
</span><span class="sub">-import Data.Maybe (catMaybes, fromJust, mapMaybe)
</span><span class="add">+import Data.Maybe (catMaybes, fromJust, listToMaybe, mapMaybe)
</span><span class="def"> import Data.Tagged (Tagged (..), untag)
</span><span class="def"> import Data.Text (Text)
</span><span class="def"> import qualified Data.Text as T
</span></pre>@@ -105,6 +105,7 @@


  <pre><span class="def">             return repo
</span><span class="def">         Just commitID -&gt; do
</span><span class="def">             let gitHead = Tagged commitID
</span><span class="add">+            headCommit &lt;- loadDiff =&lt;&lt; Git.lookupCommit gitHead
</span><span class="def"> 
</span><span class="def">             -- If a page exists for the head commit, don&apos;t do anything else --
</span><span class="def">             exists &lt;-
</span></pre>@@ -135,10 +136,8 @@


  <pre><span class="def">                 -- Copy any static files/folders into the output folder --
</span><span class="def">                 liftIO . envRepoCopyStatics env $ output
</span><span class="def"> 
</span><span class="sub">-            -- Return the repo with the head so the index page can use it. --
</span><span class="sub">-            repoHead &lt;- Git.lookupCommit gitHead -- Do this in case the block above is skipped.
</span><span class="def">             return
</span><span class="sub">-                repo{repositoryHead = Just repoHead}
</span><span class="add">+                repo{repositoryHead = Just headCommit}
</span><span class="def"> 
</span><span class="def"> {-
</span><span class="def"> The role of the function above is to gather information about a git repository and
</span></pre>@@ -151,7 +150,7 @@


  <pre><span class="def">     [Repo] -&gt;
</span><span class="def">     Path Rel Dir -&gt;
</span><span class="def">     Text -&gt;
</span><span class="sub">-    [Git.Commit LgRepo] -&gt;
</span><span class="add">+    [Commit] -&gt;
</span><span class="def">     [TreeFile] -&gt;
</span><span class="def">     [Ref] -&gt;
</span><span class="def">     [Ref] -&gt;
</span></pre>@@ -174,16 +173,30 @@


  <pre><span class="def"> {-
</span><span class="def"> Collect commit information.
</span><span class="def"> -}
</span><span class="sub">-getCommits :: Git.CommitOid LgRepo -&gt; ReaderT LgRepo IO [Git.Commit LgRepo]
</span><span class="add">+getCommits :: Git.CommitOid LgRepo -&gt; ReaderT LgRepo IO [Commit]
</span><span class="def"> getCommits commitID =
</span><span class="def">     fmap reverse . sequence . mapMaybe loadCommit
</span><span class="def">         &lt;=&lt; runConduit
</span><span class="def">         $ Git.sourceObjects Nothing commitID False .| sinkList
</span><span class="def"> 
</span><span class="sub">-loadCommit :: Git.ObjectOid LgRepo -&gt; Maybe (ReaderT LgRepo IO (Git.Commit LgRepo))
</span><span class="sub">-loadCommit (Git.CommitObjOid oid) = Just $ Git.lookupCommit oid
</span><span class="add">+loadCommit :: Git.ObjectOid LgRepo -&gt; Maybe (ReaderT LgRepo IO Commit)
</span><span class="add">+loadCommit (Git.CommitObjOid oid) = Just $ loadDiff =&lt;&lt; Git.lookupCommit oid
</span><span class="def"> loadCommit _ = Nothing
</span><span class="def"> 
</span><span class="add">+loadDiff :: Git.Commit LgRepo -&gt; ReaderT LgRepo IO Commit
</span><span class="add">+loadDiff gitCommit = do
</span><span class="add">+    let tree = Git.commitTree gitCommit
</span><span class="add">+    newTree &lt;- Git.lookupTree tree
</span><span class="add">+    oldTree &lt;-
</span><span class="add">+        case listToMaybe . Git.commitParents $ gitCommit of
</span><span class="add">+            Just parent -&gt;
</span><span class="add">+                fmap Just . Git.lookupTree . Git.commitTree =&lt;&lt; Git.lookupCommit parent
</span><span class="add">+            Nothing -&gt;
</span><span class="add">+                return Nothing
</span><span class="add">+
</span><span class="add">+    diffs &lt;- Git.diffTreeToTree oldTree (Just newTree)
</span><span class="add">+    return $ Commit gitCommit diffs
</span><span class="add">+
</span><span class="def"> {-
</span><span class="def"> Collect tree information for the given commit. Recurses on directories to list their
</span><span class="def"> contents.
</span></pre>@@ -240,8 +253,10 @@


  <pre><span class="def">     let names&apos;&apos; = map (fromJust . T.stripPrefix ref) . catMaybes . zipWith dropName maybeCommits $ names&apos;
</span><span class="def">     return . zipWith Ref names&apos;&apos; . catMaybes $ maybeCommits
</span><span class="def">   where
</span><span class="sub">-    refObjToCommit :: Git.Object r (ReaderT LgRepo IO) -&gt; ReaderT LgRepo IO (Maybe (Git.Commit r))
</span><span class="sub">-    refObjToCommit (Git.CommitObj obj) = return . Just $ obj
</span><span class="add">+    refObjToCommit ::
</span><span class="add">+        Git.Object LgRepo (ReaderT LgRepo IO) -&gt;
</span><span class="add">+        ReaderT LgRepo IO (Maybe Commit)
</span><span class="add">+    refObjToCommit (Git.CommitObj obj) = Just &lt;$&gt; loadDiff obj
</span><span class="def">     refObjToCommit _ = return Nothing
</span><span class="def"> 
</span><span class="def">     dropName :: Maybe a -&gt; Git.RefName -&gt; Maybe Git.RefName
</span></pre>@@ -275,8 +290,8 @@


  <pre><span class="def">         file &lt;- parseRelFile . identify $ t
</span><span class="def">         return $ dir &lt;/&gt; file
</span><span class="def"> 
</span><span class="sub">-instance Target (Git.Commit LgRepo) where
</span><span class="sub">-    identify = (++ &quot;.html&quot;) . show . untag . Git.commitOid
</span><span class="add">+instance Target Commit where
</span><span class="add">+    identify = (++ &quot;.html&quot;) . show . untag . Git.commitOid . commitGit
</span><span class="def">     category = const &quot;commit&quot;
</span><span class="def"> 
</span><span class="def"> instance Target TreeFile where
</span></pre></div>    </div>
  </body>
</html>
